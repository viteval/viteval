{"version":3,"sources":["server.ts"],"sourcesContent":["import type { Server } from 'node:http';\nimport path from 'node:path';\nimport express from 'express';\nimport { findUp } from 'find-up';\nimport getPort from 'get-port';\nimport tanstackServer from './dist/server/server.js';\n\nexport interface CreateVitevalServerOptions {\n  /**\n   * A custom root path to serve the UI from, otherwise will look for the `viteval.config.ts` file or `.viteval` directory\n   * @default process.cwd()\n   */\n  root?: string;\n  /**\n   * A custom port to listen on\n   * @default 3000\n   */\n  port?: number;\n  /**\n   * Turn on debug mode (used for development)\n   * @default false\n   */\n  debug?: boolean;\n}\n\n/**\n * Creates a Viteval server\n *\n * ```ts\n * const server = createVitevalServer({ port: 3000 });\n * await server.start();\n * ```\n *\n * @param options - The options for the Viteval server\n * @returns The Viteval server\n */\nexport function createVitevalServer(options?: CreateVitevalServerOptions) {\n  const app = express();\n  app.use(express.static(path.join(import.meta.dirname, 'dist', 'client')));\n  app.use(async (req, res) => {\n    const url = `${req.protocol}://${req.get('host')}${req.originalUrl}`;\n    const request = new Request(url, {\n      method: req.method,\n      headers: req.headers as HeadersInit,\n      body:\n        req.method !== 'GET' && req.method !== 'HEAD'\n          ? (req as unknown as ReadableStream)\n          : undefined,\n      // @ts-expect-error - Node.js specific option for request body handling\n      duplex: 'half',\n    });\n    const response = await tanstackServer.fetch(request);\n    res.status(response.status);\n    response.headers.forEach((value: string, key: string) => {\n      res.setHeader(key, value);\n    });\n    if (response.body) {\n      const reader = response.body.getReader();\n      const pump = async (): Promise<void> => {\n        const { done, value } = await reader.read();\n        if (done) {\n          res.end();\n          return;\n        }\n        res.write(value);\n        return pump();\n      };\n      await pump();\n    } else {\n      res.end();\n    }\n  });\n  let server: Server;\n  return {\n    /**\n     * Starts the Viteval server\n     * @returns The port the server is listening on\n     */\n    async start(): Promise<number> {\n      // set the root path in the environment variables\n      const root = await findRoot(options?.root);\n      process.env.VITEVAL_ROOT_PATH = root;\n      process.env.VITEVAL_DEBUG_MODE = options?.debug ? 'true' : 'false';\n\n      const port = await getPort({ port: options?.port ?? 3000 });\n      return new Promise((resolve) => {\n        server = app.listen(port, () => {\n          resolve(port);\n        });\n      });\n    },\n    /**\n     * Restarts the Viteval server\n     * @returns The port the server is listening on\n     */\n    async restart(): Promise<number> {\n      await this.shutdown();\n      return await this.start();\n    },\n    /**\n     * Shuts down the Viteval server\n     */\n    async shutdown(): Promise<void> {\n      return new Promise((resolve) => {\n        server.close(() => {\n          // Reset the environment variables\n          process.env.VITEVAL_ROOT_PATH = undefined;\n          process.env.VITEVAL_DEBUG_MODE = undefined;\n          resolve();\n        });\n      });\n    },\n  };\n}\n\n/*\n|------------------\n| Internals\n|------------------\n*/\n\nasync function findRoot(root: string = process.cwd()) {\n  const configFile = await findUp(\n    [\n      ...['ts', 'js', 'mts', 'mjs'].map((ext) => `viteval.config.${ext}`),\n      '.viteval',\n    ],\n    {\n      cwd: root,\n    }\n  );\n  return configFile ? path.dirname(configFile) : root;\n}\n"],"mappings":"AACA,OAAOA,MAAU,YACjB,OAAOC,MAAa,UACpB,OAAS,UAAAC,MAAc,UACvB,OAAOC,MAAa,WACpB,OAAOC,MAAoB,0BA+BpB,SAASC,EAAoBC,EAAsC,CACxE,MAAMC,EAAMN,EAAQ,EACpBM,EAAI,IAAIN,EAAQ,OAAOD,EAAK,KAAK,YAAY,QAAS,OAAQ,QAAQ,CAAC,CAAC,EACxEO,EAAI,IAAI,MAAOC,EAAKC,IAAQ,CAC1B,MAAMC,EAAM,GAAGF,EAAI,QAAQ,MAAMA,EAAI,IAAI,MAAM,CAAC,GAAGA,EAAI,WAAW,GAC5DG,EAAU,IAAI,QAAQD,EAAK,CAC/B,OAAQF,EAAI,OACZ,QAASA,EAAI,QACb,KACEA,EAAI,SAAW,OAASA,EAAI,SAAW,OAClCA,EACD,OAEN,OAAQ,MACV,CAAC,EACKI,EAAW,MAAMR,EAAe,MAAMO,CAAO,EAKnD,GAJAF,EAAI,OAAOG,EAAS,MAAM,EAC1BA,EAAS,QAAQ,QAAQ,CAACC,EAAeC,IAAgB,CACvDL,EAAI,UAAUK,EAAKD,CAAK,CAC1B,CAAC,EACGD,EAAS,KAAM,CACjB,MAAMG,EAASH,EAAS,KAAK,UAAU,EACjCI,EAAO,SAA2B,CACtC,KAAM,CAAE,KAAAC,EAAM,MAAAJ,CAAM,EAAI,MAAME,EAAO,KAAK,EAC1C,GAAIE,EAAM,CACRR,EAAI,IAAI,EACR,MACF,CACA,OAAAA,EAAI,MAAMI,CAAK,EACRG,EAAK,CACd,EACA,MAAMA,EAAK,CACb,MACEP,EAAI,IAAI,CAEZ,CAAC,EACD,IAAIS,EACJ,MAAO,CAKL,MAAM,OAAyB,CAE7B,MAAMC,EAAO,MAAMC,EAASd,GAAS,IAAI,EACzC,QAAQ,IAAI,kBAAoBa,EAChC,QAAQ,IAAI,mBAAqBb,GAAS,MAAQ,OAAS,QAE3D,MAAMe,EAAO,MAAMlB,EAAQ,CAAE,KAAMG,GAAS,MAAQ,GAAK,CAAC,EAC1D,OAAO,IAAI,QAASgB,GAAY,CAC9BJ,EAASX,EAAI,OAAOc,EAAM,IAAM,CAC9BC,EAAQD,CAAI,CACd,CAAC,CACH,CAAC,CACH,EAKA,MAAM,SAA2B,CAC/B,aAAM,KAAK,SAAS,EACb,MAAM,KAAK,MAAM,CAC1B,EAIA,MAAM,UAA0B,CAC9B,OAAO,IAAI,QAASC,GAAY,CAC9BJ,EAAO,MAAM,IAAM,CAEjB,QAAQ,IAAI,kBAAoB,OAChC,QAAQ,IAAI,mBAAqB,OACjCI,EAAQ,CACV,CAAC,CACH,CAAC,CACH,CACF,CACF,CAQA,eAAeF,EAASD,EAAe,QAAQ,IAAI,EAAG,CACpD,MAAMI,EAAa,MAAMrB,EACvB,CACE,GAAG,CAAC,KAAM,KAAM,MAAO,KAAK,EAAE,IAAKsB,GAAQ,kBAAkBA,CAAG,EAAE,EAClE,UACF,EACA,CACE,IAAKL,CACP,CACF,EACA,OAAOI,EAAavB,EAAK,QAAQuB,CAAU,EAAIJ,CACjD","names":["path","express","findUp","getPort","tanstackServer","createVitevalServer","options","app","req","res","url","request","response","value","key","reader","pump","done","server","root","findRoot","port","resolve","configFile","ext"]}