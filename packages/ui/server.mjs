import c from"node:path";import m from"express";import{findUp as l}from"find-up";import v from"get-port";import h from"./dist/server/server.js";function P(r){const o=m();o.use(m.static(c.join(import.meta.dirname,"dist","client"))),o.use(async(e,t)=>{const i=`${e.protocol}://${e.get("host")}${e.originalUrl}`,p=new Request(i,{method:e.method,headers:e.headers,body:e.method!=="GET"&&e.method!=="HEAD"?e:void 0,duplex:"half"}),n=await h.fetch(p);if(t.status(n.status),n.headers.forEach((d,a)=>{t.setHeader(a,d)}),n.body){const d=n.body.getReader(),a=async()=>{const{done:u,value:f}=await d.read();if(u){t.end();return}return t.write(f),a()};await a()}else t.end()});let s;return{async start(){const e=await w(r?.root);process.env.VITEVAL_ROOT_PATH=e,process.env.VITEVAL_DEBUG_MODE=r?.debug?"true":"false";const t=await v({port:r?.port??3e3});return new Promise(i=>{s=o.listen(t,()=>{i(t)})})},async restart(){return await this.shutdown(),await this.start()},async shutdown(){return new Promise(e=>{s.close(()=>{process.env.VITEVAL_ROOT_PATH=void 0,process.env.VITEVAL_DEBUG_MODE=void 0,e()})})}}}async function w(r=process.cwd()){const o=await l([...["ts","js","mts","mjs"].map(s=>`viteval.config.${s}`),".viteval"],{cwd:r});return o?c.dirname(o):r}export{P as createVitevalServer};
//# sourceMappingURL=server.mjs.map